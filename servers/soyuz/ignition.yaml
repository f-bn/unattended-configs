---
version: 1.6.0
variant: fcos
passwd:
  users:
    - name: fbobin
      gecos: Florian Bobin
      groups: ["adm", "wheel", "systemd-journal"]
      password_hash: "<redacted>"
      ssh_authorized_keys: []
    - name: ansible
      gecos: Ansible technical user
      ssh_authorized_keys: []
kernel_arguments:
  should_exist:
    # Disable SELinux (at kernel level)
    - selinux=0
    # Disable kernel audit logging
    - audit=0
storage:
  disks:
    - device: /dev/sda
      wipe_table: false
      partitions:
        - label: logs
          number: 1
          size_mib: 20480
        - label: containers-data
          number: 2
          size_mib: 0
  filesystems:
    - device: /dev/disk/by-partlabel/logs
      format: xfs
      wipe_filesystem: true
    - device: /dev/disk/by-partlabel/containers-data
      format: xfs
      wipe_filesystem: false
  directories:
    - path: /etc/deployments
      mode: 0755
    - path: /var/lib/deployments
      mode: 0755
    - path: /var/mnt/nas/music
      mode: 0755
    - path: /var/mnt/nas/backups
      mode: 0755
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: soyuz
    - path: /etc/vconsole.conf
      mode: 0644
      contents:
        inline: KEYMAP=fr
    - path: /etc/hosts
      mode: 0644
      overwrite: true
      contents:
        inline: |
          # Generated by Afterburn
          #
          # Loopback entries
          127.0.0.1     localhost localhost.localdomain localhost4 localhost4.localdomain4
          ::1           localhost localhost.localdomain localhost6 localhost6.localdomain6
          # Custom entries
          192.168.144.2 polis.priv.fbobin.fr polis
          192.168.144.2 nas.priv.fbobin.fr   nas
    - path: /etc/subuid
      mode: 0644
      overwrite: true
      contents:
        inline: |
          core:524288:65536
          containers:1000000:1000000
    - path: /etc/subgid
      mode: 0644
      overwrite: true
      contents:
        inline: |
          core:524288:65536
          containers:1000000:1000000
    - path: /etc/sysctl.d/99-custom.conf
      mode: 0644
      contents:
        inline: |
          # Generated by Afterburn
          #
          # Virtual Memory -
          vm.max_map_count = 262144
          vm.swappiness = 10
          # - Networking -
          net.core.rmem_max = 134217728
          net.core.wmem_max = 134217728
          net.ipv4.tcp_rmem = 4096 65536 134217728
          net.ipv4.tcp_wmem = 4096 65536 134217728
          net.core.netdev_max_backlog = 5000
          net.ipv4.tcp_congestion_control = bbr
          # - File system -
          fs.file-max = 2097152
          fs.inotify.max_user_watches = 1048576
          fs.inotify.max_user_instances = 1024
          # - Process and memory management -
          kernel.pid_max = 4194304
          # - Security hardening -
          net.ipv4.conf.all.rp_filter = 1
          net.ipv4.conf.default.rp_filter = 1
          net.ipv4.ip_forward = 1
          net.ipv6.conf.all.forwarding = 1
          kernel.dmesg_restrict = 1
    - path: /etc/NetworkManager/system-connections/enp1s0.nmconnection
      mode: 0600
      contents:
        inline: |
          # Generated by Afterburn
          #
          [connection]
          id=enp1s0
          type=ethernet
          interface-name=enp1s0
          [ipv4]
          method=manual
          address1=192.168.144.3/24,192.168.144.1
          dns=192.168.144.2;
          dns-search=priv.fbobin.fr;
          may-fail=false
    - path: /etc/sudoers.d/00-defaults
      mode: 0440
      contents:
        inline: |
          # Generated by Afterburn
          #
          Defaults lecture=never
          Defaults passwd_timeout=1
    - path: /etc/sudoers.d/01-rules
      mode: 0440
      contents:
        inline: |
          # Generated by Afterburn
          #
          # Only allow Ansible user to have passwordless sudo
          ansible ALL=(ALL) NOPASSWD:ALL
    - path: /etc/ssh/sshd_config.d/10-override.conf
      mode: 0644
      contents:
        inline: |
          # Generated by Afterburn
          #
          # See sshd_config(5) for details.
          Port 22
          ListenAddress 192.168.144.3
          HostKey /etc/ssh/ssh_host_ed25519_key
          LogLevel INFO
          LoginGraceTime 30s
          PermitRootLogin no
          PubkeyAuthentication yes
          PasswordAuthentication no
          PermitEmptyPasswords no
          AllowUsers fbobin ansible
          UsePAM yes
          PrintMotd yes
          AllowAgentForwarding no
          AllowTcpForwarding yes
          X11Forwarding no
          IgnoreRhosts yes
          MaxAuthTries 5
          UseDNS no
    - path: /etc/systemd/journald.conf
      mode: 0644
      contents:
        inline: |
          # Generated by Afterburn
          #
          # See journald.conf(5) for details.
          [Journal]
          Storage=persistent
          Compress=yes
          SystemMaxFileSize=256M
          SystemKeepFree=5G
          RuntimeMaxUse=100M
          MaxRetentionSec=3day
    - path: /etc/chrony.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          # Generated by Afterburn
          #
          pool 0.fr.pool.ntp.org iburst
          pool 1.fr.pool.ntp.org iburst
          pool 2.fr.pool.ntp.org iburst
          pool 3.fr.pool.ntp.org iburst
          makestep 1.0 3
          rtcsync
          driftfile /var/lib/chrony/drift
    - path: /etc/zincati/config.d/80-rollout-wariness.toml
      mode: 0644
      contents:
        inline: |
          # Generated by Afterburn
          #
          [identity]
          rollout_wariness = 0.25
    - path: /etc/zincati/config.d/80-updates-strategy.toml
      mode: 0644
      contents:
        inline: |
          # Generated by Afterburn
          #
          [updates]
          strategy = "periodic"
          [[updates.periodic.window]]
          days = [ "Sat", "Sun" ]
          start_time = "03:00"
          length_minutes = 60
    - path: /etc/containers/registries.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          # Generated by Afterburn
          #
          unqualified-search-registries = [
            'docker.io',
            'quay.io',
            'ghcr.io',
            'registry.access.redhat.com',
            'registry.fedoraproject.org'
          ]
          short-name-mode = "enforcing"
    - path: /etc/containers/containers.conf
      mode: 0644
      contents:
        inline: |
          # Generated by Afterburn
          #
          [containers]
          pids_limit = 512
          default_ulimits = [
            "nofile=65536:65536"
          ]
          log_driver = "journald"
          [network]
          network_backend = "netavark"
          [engine]
          cgroup_manager = "systemd"
          database_backend = "sqlite"
          events_logger = "journald"
          healthcheck_events = false
    - path: /etc/containers/toolbox.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          # Generated by Afterburn
          #
          [general]
          image = "ghcr.io/f-bn/coreos-toolbox:42"
systemd:
  units:
    # Services
    - name: irqbalance.service
      mask: true
    - name: auditd.service
      mask: true
    - name: sshd.service
      dropins:
        - name: 10-wait-network-online.conf
          contents: |
            [Unit]
            Wants=network-online.target
            After=network-online.target
    - name: docker.service
      mask: true
    - name: docker.socket
      mask: true
    - name: podman.service
      enabled: true
      dropins:
        - name: 10-override-exec.conf
          contents: |
            [Service]
            ExecStart=
            ExecStart=/usr/bin/podman --log-level=warn system service -t 0
    - name: podman.socket
      enabled: true
    - name: podman-auto-update.timer
      enabled: true
    - name: bootloader-update.service
      enabled: true
    # Swap
    - name: var-swap-init.service
      enabled: true
      contents: |
        [Unit]
        Description=Initialize swapfile on /var/swap
        RequiresMountsFor=/var
        DefaultDependencies=no
        ConditionPathExists=!/var/swap
        [Service]
        Type=oneshot
        ExecStart=/usr/sbin/mkswap --file --size 8192m /var/swap
        RemainAfterExit=yes
        [Install]
        WantedBy=multi-user.target
    - name: var-swap.swap
      enabled: true
      contents: |
        [Unit]
        Description=Enable swapfile on /var/swap
        Requires=var-swap-init.service
        After=var-swap-init.service
        [Swap]
        What=/var/swap
        [Install]
        WantedBy=multi-user.target
    # Mounts (local)
    - name: var-log.mount
      enabled: true
      contents: |
        [Unit]
        Description=System logs and journal
        Before=local-fs.target
        [Mount]
        Type=xfs
        What=/dev/disk/by-partlabel/logs
        Where=/var/log
        Options=defaults
        [Install]
        WantedBy=local-fs.target
    - name: var-lib-deployments.mount
      enabled: true
      contents: |
        [Unit]
        Description=Containers deployments persistent disk
        Before=local-fs.target
        [Mount]
        Type=xfs
        What=/dev/disk/by-partlabel/containers-data
        Where=/var/lib/deployments
        Options=defaults,pquota
        [Install]
        WantedBy=local-fs.target
    # Mounts (NFS)
    - name: var-mnt-nas-music.mount
      enabled: true
      contents: |
        [Unit]
        Description=NFS share for music
        Requires=network-online.target
        After=network-online.target
        [Mount]
        Type=nfs
        What=nas.priv.fbobin.fr:/volume1/media/music
        Where=/var/mnt/nas/music
        Options=defaults,nfsvers=4.1,rsize=131072,wsize=131072,ac,ro
        [Install]
        WantedBy=remote-fs.target
    - name: var-mnt-nas-backups.mount
      enabled: true
      contents: |
        [Unit]
        Description=NFS share for backups
        Requires=network-online.target
        After=network-online.target
        [Mount]
        Type=nfs
        What=nas.priv.fbobin.fr:/volume1/backups
        Where=/var/mnt/nas/backups
        Options=defaults,nfsvers=4.1,rsize=131072,wsize=131072,ac,noexec,rw
        [Install]
        WantedBy=remote-fs.target
    # Packages layring (rpm-ostree)
    - name: rpm-ostree-install@.service
      contents: |
        # Generated by Afterburn
        #
        [Unit]
        Description=Install %i package (rpm-ostree)
        Wants=network-online.target
        After=network-online.target
        Before=zincati.service
        ConditionPathExists=!/var/lib/%N.stamp
        [Service]
        Type=oneshot
        ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive %i
        ExecStart=/usr/sbin/touch /var/lib/%N.stamp
        ExecStart=/usr/sbin/systemctl --no-block reboot
        RemainAfterExit=yes
        [Install]
        WantedBy=multi-user.target
    - name: rpm-ostree-install@python3.service
      enabled: true
